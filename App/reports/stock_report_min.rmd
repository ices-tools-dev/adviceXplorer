---
title: "adviceXplorer Offline Report"
output:
  ioslides_presentation:
    widescreen: true
    incremental: false
    self_contained: true
    css: ioslides-advice.css
params:
  app_dir: null
  assessmentkey: null
  assessmentcomponent: null
  stockkeylabel: null
  year: null
  headline: null
  stock_descr: null
  adviceKey: null
  
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

## Stock information {.fit}

<div class="fitbox wrap">
<strong>Stock description:</strong> `r params$stock_descr`<br/>
<strong>Stock code:</strong> `r params$stockkeylabel`<br/>
<strong>Year:</strong> `r params$year`<br/>
<strong>Assessment component:</strong> `r ifelse(is.na(params$assessmentcomponent), "NA", params$assessmentcomponent)`<br/>
<strong>AssessmentKey:</strong> `r params$assessmentkey`<br/>
<strong>File generated:</strong> `r format(Sys.time(), "%Y-%m-%d %H:%M:%S")`
</div>

## Headline advice {.fit}

```{r echo=FALSE, results='asis'}
cat('<div class="fitbox wrap">', htmltools::htmlEscape(params$headline), '</div>')
```





```{r downloading_data}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(dplyr)
library(plotly)
library(htmltools)
library(reactable)
library(icesSAG)
library(icesASD)
library(icesSD)
library(data.table)
library(dplyr)
library(dygraphs)
library(DT)
library(htmltools)
library(htmlwidgets)
library(ggplot2)
library(ggradar)
library(ggtext)
library(glue)
library(gsubfn)
library(icesSAG)
library(icesTAF)
library(icesVocab)
library(leaflet)
library(plotly)
library(reshape2)
library(rintrojs)
library(RColorBrewer)
library(RCurl)
library(rvest)
library(scales)
library(sf)
library(shinyalert)
library(shinyBS)
library(shinycssloaders)
library(shinyjs)
library(shinythemes)
library(shinyWidgets)
library(stringr)
library(tidyr)
library(tidyverse)
library(tm)
library(widgetframe)
library(icesASD)
library(zip)
library(datamods)
library(reactable)
library(ggthemes)

# Source your existing code from the app folder
app_dir <- params$app_dir
stopifnot(!is.null(app_dir))

source(file.path(app_dir, "utilities_help.r"))
source(file.path(app_dir, "utilities_sag_data.r"))
source(file.path(app_dir, "utilities_plotting.r"))
source(file.path(app_dir, "utilities_catch_scenarios.r"))
source(file.path(app_dir, "utilities_resources.r"))

assessmentkey <- params$assessmentkey
req_assessmentkey <- function(x) if (is.null(x) || is.na(x)) stop("assessmentkey is missing") else x
assessmentkey <- req_assessmentkey(assessmentkey)

info <- getStockInfoFromSAG(assessmentkey)
sagStamp <- info$SAGStamp
# sag
sag <- getSAGData(assessmentkey)

# sag settings
sagSettings <- icesSAG::getSAGSettingsForAStock(assessmentkey)
sagSettings <- sagSettings[sagSettings$settingValue != "", , drop = FALSE]

# quality of assessment
yearsToDisplay <- sagSettings %>%
      filter(settingKey == 58) %>%
      pull(settingValue) %>%
      # str_split(",", simplify = TRUE) %>%
      as.numeric() %>%
      nullifempty()

aq <- getSAGQualityAssessment(params$stockkeylabel, params$year, params$assessmentcomponent, yearsToDisplay)

drop_plots <- sagSettings %>%
  filter(settingKey == 22, settingValue %in% c("yes", "y")) %>%
  pull(SAGChartKey) %>%
  as.numeric()


has_any <- function(x) any(!is.na(x) & x != "")

is_dropped_key <- function(key) {
  !is.null(
    sagSettings %>%
      filter(SAGChartKey == key, settingKey == 22) %>%
      pull(settingValue) %>%
      nullifempty()
  )
}

# catch scenarios
catch_scenario_table <- standardize_catch_scenario_table(icesASD::get_catch_scenario_table(params$adviceKey, params$year))
catch_scenario_table_collated <- catch_scenario_table$table %>%
    arrange(cS_Purpose) %>%
    rename_all(~ catch_scenario_table$cols) %>% 
    rename("Basis" = cS_Label) %>% #, " " = cS_Purpose
    select_if(~!(all(is.na(.)) | all(. == "")))
```

## Stock development over time - Catches
```{r Catches,echo=FALSE}
if (!is_dropped_key(1) && (has_any(sag$Landings) || has_any(sag$Catches))) {
  p1 <- suppressWarnings(ICES_plot_1(sag, sagSettings, sagStamp))
  htmltools::div(style = "width: 100%; height: 900px;", p1)
}
```

## Development over time – Recruitment
```{r Recruitment, echo=FALSE}
if (!is_dropped_key(2) && has_any(sag$Recruitment)) {
  p2 <- suppressWarnings(ICES_plot_2(sag, sagSettings, sagStamp))
  htmltools::div(style = "width: 100%; height: 900px;", p2)
}
```

## Development over time – Fishing pressure
```{r F, echo=FALSE}
if (!is_dropped_key(3) && has_any(sag$FishingPressure)) {
  p3 <- suppressWarnings(ICES_plot_3(sag, sagSettings, sagStamp))
  htmltools::div(style = "width: 100%; height: 900px;", p3)
}
```

## Development over time – SSB
```{r SSB, echo=FALSE}
if (!is_dropped_key(4) && has_any(sag$StockSize)) {
  p4 <- suppressWarnings(ICES_plot_4(sag, sagSettings, sagStamp))
  htmltools::div(style = "width: 100%; height: 900px;", p4)
}

```

## Custom plot 1
```{r custom1, echo=FALSE}
if (nrow(sagSettings %>% filter(SAGChartKey == 15)) >= 1) {
  pc1 <- suppressWarnings(ICES_custom_plot(sag, sagSettings, ChartKey = 15, sagStamp))
  htmltools::div(style = "width: 100%; height: 900px;", pc1)
}

```

## Custom plot 2
```{r custom2, echo=FALSE}
if (nrow(sagSettings %>% filter(SAGChartKey == 16)) >= 1) {
  pc2 <- suppressWarnings(ICES_custom_plot(sag, sagSettings, ChartKey = 16, sagStamp))
  htmltools::div(style = "width: 100%; height: 900px;", pc2)
}

```

## Custom plot 3
```{r custom3, echo=FALSE}
if (nrow(sagSettings %>% filter(SAGChartKey == 17)) >= 1) {
  pc3 <- suppressWarnings(ICES_custom_plot(sag, sagSettings, ChartKey = 17, sagStamp))
  htmltools::div(style = "width: 100%; height: 900px;", pc3)
}

```

## Custom plot 4
```{r custom4, echo=FALSE}
if (nrow(sagSettings %>% filter(SAGChartKey == 18)) >= 1) {
  pc4 <- suppressWarnings(ICES_custom_plot(sag, sagSettings, ChartKey = 18, sagStamp))
  htmltools::div(style = "width: 100%; height: 900px;", pc4)
}

```

## Quality of assessment - SSB
```{r qual_assess_SSB, echo=FALSE}
if (!is.null(aq) && has_any(aq$StockSize) && !10 %in% drop_plots) {
  p5 <- suppressWarnings(ICES_plot_5(aq, sagSettings, sagStamp))
  htmltools::div(style = "width:100%; height:800px;", p5)
} else {
  # optional message:
  # cat("<p>No SSB quality plot available for this stock.</p>")
}
```

## Quality of assessment - Fishing pressure
```{r qual_assess_F, echo=FALSE}
if (!is.null(aq) && has_any(aq$FishingPressure) && !10 %in% drop_plots) {
  p6 <- suppressWarnings(ICES_plot_6(aq, sagSettings, sagStamp))
  htmltools::div(style = "width:100%; height:800px;", p6)
} else {
  # optional message:
  # cat("<p>No fishing pressure quality plot available for this stock.</p>")
}
```

## Quality of assessment - Recruitment
```{r qual_assess_R, echo=FALSE}
if (!is.null(aq) && has_any(aq$Recruitment) && !10 %in% drop_plots) {
  p7 <- suppressWarnings(ICES_plot_7(aq, sagSettings, sagStamp))
  htmltools::div(style = "width:100%; height:700px;", p7)
} else {
  # optional message:
  # cat("<p>No recruitment quality plot available for this stock.</p>")
}
```

## Catch scenarios - plot
```{r catch_F_SSB_plot, echo=FALSE}
if (str_detect(tail(params$stockkeylabel), "nep")) {
    F_SSB_Catch <- catch_scenario_plot_1_nephrops(catch_scenario_table, sag, sagSettings)
    htmltools::div(style = "width:100%; height:700px;", F_SSB_Catch)
  } else {
    F_SSB_Catch <- catch_scenario_plot_1(catch_scenario_table, sag, sagSettings)
    htmltools::div(style = "width:100%; height:100%;", F_SSB_Catch)
  }
```

## Catch scenarios - table
```{r table, echo=FALSE}
t1 <- reactable(catch_scenario_table_collated %>% select(!(Year)),
  rowStyle = function(index) {
    if (catch_scenario_table_collated[index, "cS_Purpose"] == "Basis Of Advice") list(fontWeight = "bold")
  },
    filterable = TRUE,
    highlight = TRUE,
    defaultPageSize = 100,
    striped = TRUE,
    defaultColDef = colDef(
      headerStyle = list(background = "#99AABF", borderRight = "1px solid #eee")

    ),
    columns = list(
      "cS_Purpose" = colDef(
        show = FALSE
      )
    ),
    theme = reactableTheme(
      stripedColor = "#eff2f5",
      highlightColor = "#f9b99f",
      cellPadding = "2px 2px"
    )
  )
t1
```
