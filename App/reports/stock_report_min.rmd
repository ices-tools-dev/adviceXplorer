---
title: "adviceXplorer Offline Stock Report"
output:
  ioslides_presentation:
    widescreen: true
    incremental: false
    self_contained: true
params:
  app_dir: null
  assessmentkey: null
  assessmentcomponent: null
  stockkeylabel: null
  year: null
  headline: null
  stock_descr: null
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

## Stock information
### Stock description: `r params$stock_descr`
### Stock code: `r params$stockkeylabel`
### Year: `r params$year`
### Assessment component: `r ifelse(is.na(params$assessmentcomponent), "NA", params$assessmentcomponent)`
### AssessmentKey: `r params$assessmentkey`
### File generated: `r format(Sys.time(), "%Y-%m-%d %H:%M:%S")`

## Headline advice
```{r echo=FALSE, results='asis'}
cat("<p>", htmltools::htmlEscape(params$headline), "</p>")
```





```{r}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(dplyr)
library(plotly)
library(htmltools)
library(reactable)
library(icesSAG)
library(icesASD)
library(icesSD)
library(data.table)
library(dplyr)
library(dygraphs)
library(DT)
library(htmltools)
library(htmlwidgets)
library(ggplot2)
library(ggradar)
library(ggtext)
library(glue)
library(gsubfn)
library(icesSAG)
library(icesTAF)
library(icesVocab)
library(leaflet)
library(plotly)
library(reshape2)
library(rintrojs)
library(RColorBrewer)
library(RCurl)
library(rvest)
library(scales)
library(sf)
library(shinyalert)
library(shinyBS)
library(shinycssloaders)
library(shinyjs)
library(shinythemes)
library(shinyWidgets)
library(stringr)
library(tidyr)
library(tidyverse)
library(tm)
library(widgetframe)
library(icesASD)
library(zip)
library(datamods)
library(reactable)
library(ggthemes)

# Source your existing code from the app folder
app_dir <- params$app_dir
stopifnot(!is.null(app_dir))

source(file.path(app_dir, "utilities_help.r"))
source(file.path(app_dir, "utilities_sag_data.r"))
source(file.path(app_dir, "utilities_plotting.r"))
source(file.path(app_dir, "utilities_catch_scenarios.r"))
source(file.path(app_dir, "utilities_resources.r"))

assessmentkey <- params$assessmentkey
req_assessmentkey <- function(x) if (is.null(x) || is.na(x)) stop("assessmentkey is missing") else x
assessmentkey <- req_assessmentkey(assessmentkey)

info <- getStockInfoFromSAG(assessmentkey)
sagStamp <- info$SAGStamp

sag <- getSAGData(assessmentkey)

sagSettings <- icesSAG::getSAGSettingsForAStock(assessmentkey)
sagSettings <- sagSettings[sagSettings$settingValue != "", , drop = FALSE]

drop_plots <- sagSettings %>%
  filter(settingKey == 22, settingValue %in% c("yes", "y")) %>%
  pull(SAGChartKey) %>%
  as.numeric()

has_any <- function(x) any(!is.na(x) & x != "")

is_dropped_key <- function(key) {
  !is.null(
    sagSettings %>%
      filter(SAGChartKey == key, settingKey == 22) %>%
      pull(settingValue) %>%
      nullifempty()
  )
}
```

## Stock development over time - Catches
```{r Catches,echo=FALSE}
if (!is_dropped_key(1) && (has_any(sag$Landings) || has_any(sag$Catches))) {
  p1 <- suppressWarnings(ICES_plot_1(sag, sagSettings, sagStamp))
  htmltools::div(style = "width: 100%; height: 900px;", p1)
}
```

## Development over time – Recruitment
```{r Recruitment, echo=FALSE}
if (!is_dropped_key(2) && has_any(sag$Recruitment)) {
  p2 <- suppressWarnings(ICES_plot_2(sag, sagSettings, sagStamp))
  htmltools::div(style = "width: 100%; height: 900px;", p2)
}
```

## Development over time – Fishing pressure
```{r F, echo=FALSE}
if (!is_dropped_key(3) && has_any(sag$FishingPressure)) {
  p3 <- suppressWarnings(ICES_plot_3(sag, sagSettings, sagStamp))
  htmltools::div(style = "width: 100%; height: 900px;", p3)
}
```

## Development over time – SSB
```{r SSB, echo=FALSE}
if (!is_dropped_key(4) && has_any(sag$StockSize)) {
  p4 <- suppressWarnings(ICES_plot_4(sag, sagSettings, sagStamp))
  htmltools::div(style = "width: 100%; height: 900px;", p4)
}

```

## Custom plot 1
```{r custom1, echo=FALSE}
if (nrow(sagSettings %>% filter(SAGChartKey == 15)) >= 1) {
  pc1 <- suppressWarnings(ICES_custom_plot(sag, sagSettings, ChartKey = 15, sagStamp))
  htmltools::div(style = "width: 100%; height: 900px;", pc1)
}

```

## Custom plot 2
```{r custom2, echo=FALSE}
if (nrow(sagSettings %>% filter(SAGChartKey == 16)) >= 1) {
  pc2 <- suppressWarnings(ICES_custom_plot(sag, sagSettings, ChartKey = 16, sagStamp))
  htmltools::div(style = "width: 100%; height: 900px;", pc2)
}

```

## Custom plot 3
```{r custom3, echo=FALSE}
if (nrow(sagSettings %>% filter(SAGChartKey == 17)) >= 1) {
  pc3 <- suppressWarnings(ICES_custom_plot(sag, sagSettings, ChartKey = 17, sagStamp))
  htmltools::div(style = "width: 100%; height: 900px;", pc3)
}

```

## Custom plot 4
```{r custom4, echo=FALSE}
if (nrow(sagSettings %>% filter(SAGChartKey == 18)) >= 1) {
  pc4 <- suppressWarnings(ICES_custom_plot(sag, sagSettings, ChartKey = 18, sagStamp))
  htmltools::div(style = "width: 100%; height: 900px;", pc4)
}

```